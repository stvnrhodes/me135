Maze=function(a){this.node_list=[[new Node]];this.yOffset=this.xOffset=0;1==arguments.length&&this._parseAndAdd(a)};Maze.prototype._parseAndAdd=function(a){for(i=0;i<a.maze.length;i++)for(j=0;j<a.maze[i].length;j++)this._node(i+a.x0,j+a.y0)._parseAndAdd(a.maze[i][j],this)};
Maze.prototype._node=function(a,b){for(;0>a+this.xOffset;){for(var c=[],d=this.getWidth()-1;0<=d;d--)c.push(new Node);this.node_list.unshift(c);this.xOffset++}for(;0>b+this.yOffset;)this.node_list.forEach(function(a){a.unshift(new Node)}),this.yOffset++;for(;a+this.xOffset>=this.getHeight();){c=[];for(d=this.getWidth()-1;0<=d;d--)c.push(new Node);this.node_list.push(c)}for(;b+this.yOffset>=this.getWidth();)this.node_list.forEach(function(a){a.push(new Node)});c=this.node_list[a+this.xOffset][b+this.yOffset];
c.loc||(c.loc=[a,b]);return c};Maze.prototype.getData=function(){var a,b=[];a=this.getCorners();for(var c=a[0][0],d=a[0][1],e=a[1][0],h=a[1][1],f=c;f<e;f++){a=[];for(var g=d;g<h;g++)a.push(this._node(f,g).getData());b.push(a)}return{maze:b,x0:c,y0:d}};Maze.prototype.getWidth=function(){return this.node_list[0].length};Maze.prototype.getHeight=function(){return this.node_list.length};Maze.prototype.setExplored=function(a,b){this._node(a,b).setExplored()};
Maze.prototype.isWall=function(a,b,c,d){return 1===Math.abs(c-a)+Math.abs(d-b)?this._node(a,b).isWall(this._node(c,d)):!1};Maze.prototype.isEdge=function(a,b,c,d){return 1===Math.abs(c-a)+Math.abs(d-b)?this._node(a,b).isEdge(this._node(c,d)):!1};Maze.prototype.addWall=function(a,b,c,d){1===Math.abs(c-a)+Math.abs(d-b)&&(a=this._node(a,b),c=this._node(c,d),a.addWall(c),c.addWall(a))};
Maze.prototype.addEdge=function(a,b,c,d){1===Math.abs(c-a)+Math.abs(d-b)&&(a=this._node(a,b),c=this._node(c,d),a.addEdge(c),c.addEdge(a))};
Maze.prototype.getPath=function(a,b,c,d){a=this._node(a,b);var e=this._node(c,d);if(a===e)return null;b=a;for(var h=[],f={},g=[];b!==e;){for(var g=b.getEdgesNotWalls(this,null,null),k=0;k<g.length;k++){var l=g[k];f[l.loc]||(f[l.loc]=b,h.push(l))}h=Node.sort(h,function(a){return a.ManhattanDist(c,d)});b=h.shift();if(!b)return null}for(e=[];b!==a;)e.unshift(b.loc),b=f[b.loc];return e};
Maze.prototype.getPathToUnknown=function(a,b){for(var c=this._node(a,b),d=c,e=[],h={},f=[];d.isExplored();){for(var f=d.getEdgesNotWalls(this,null,null),g=0;g<f.length;g++){var k=f[g];h[k.loc]||(h[k.loc]=d,e.push(k))}d=e.shift();if(!d)return null}for(e=[];d!==c;)e.unshift(d.loc),d=h[d.loc];return e};Maze.prototype.isExplored=function(a,b){return this._node(a,b).isExplored()};
Maze.prototype.getCorners=function(){var a=-this.xOffset,b=-this.yOffset,c=a+this.getHeight(),d=b+this.getWidth();return[[a,b],[c,d]]};Node=function(){this.explored=!1;this.edges=[];this.walls=[]};Node.prototype._parseAndAdd=function(a,b){this.explored=a.ex;for(var c=0;c<a.e.length;c++){var d=a.e[c];this.edges.push(b._node(d[0],d[1]))}for(c=0;c<a.w.length;c++)d=a.w[c],this.walls.push(b._node(d[0],d[1]))};
Node.prototype.getData=function(){for(var a={e:[]},b=0;b<this.edges.length;b++)a.e.push(this.edges[b].loc);a.w=[];for(b=0;b<this.walls.length;b++)a.w.push(this.walls[b].loc);a.ex=this.explored;return a};Node.prototype.getEdges=function(){return this.edges};Node.prototype.ManhattanDist=function(a,b){return Math.abs(this.loc[0]-a)+Math.abs(this.loc[1]-b)};
Node.sort=function(a,b){if(1>=a.length)return a;for(var c=a.splice(a.length/2),c=Node.sort(c,b),d=Node.sort(a,b),e=[];0!==c.length&&0!==d.length;)b(c[0])<b(d[0])?e.push(c.shift()):e.push(d.shift());for(;0!==c.length;)e.push(c.shift());for(;0!==d.length;)e.push(d.shift());return e};
Node.prototype.getEdgesNotWalls=function(a){a=[a._node(this.loc[0],this.loc[1]+1),a._node(this.loc[0],this.loc[1]-1),a._node(this.loc[0]+1,this.loc[1]),a._node(this.loc[0]-1,this.loc[1])];for(var b=[],c=0;c<a.length;c++)-1===this.walls.indexOf(a[c])&&b.push(a[c]);return b};Node.prototype.getWalls=function(){return thus.walls};Node.prototype.addWall=function(a){this.walls.push(a);for(var b=0;b<this.edges.length;b++)a===this.edges[b]&&this.edges.splice(b,1)};
Node.prototype.addEdge=function(a){this.edges.push(a);for(var b=0;b<this.walls.length;b++)a===this.walls[b]&&this.walls.splice(b,1)};Node.prototype.isEdge=function(a){for(var b=this.edges.length-1;0<=b;b--)if(this.edges[b]===a)return!0;return!1};Node.prototype.isWall=function(a){for(var b=this.walls.length-1;0<=b;b--)if(this.walls[b]===a)return!0;return!1};Node.prototype.isExplored=function(){return this.explored};Node.prototype.setExplored=function(){this.explored=!0};
Cell=function(a,b,c,d){2==arguments.length?(this.x=a[0],this.y=a[1],this.dir=a[2],this.maze=b):(this.x=a,this.y=b,this.dir=Cell.dirTable[c],this.maze=d);this.maze.setExplored(this.x,this.y)};Cell.dirTable={N:0,W:1,S:2,E:3,n:0,w:1,s:2,e:3,F:0,L:1,B:2,R:3,f:0,l:1,b:2,r:3};Cell.invDirTable=["f","l","b","r"];Cell.prototype.addWall=function(a){a=(Cell.dirTable[a]+this.dir)%4;var b=this.x,c=this.y;0===a?b-=1:1===a?c-=1:2===a?b+=1:3===a&&(c+=1);this.maze.addWall(this.x,this.y,b,c)};
Cell.prototype.addConnect=function(a){a=(Cell.dirTable[a]+this.dir)%4;var b=this.x,c=this.y;0===a?b-=1:1===a?c-=1:2===a?b+=1:3===a&&(c+=1);this.maze.addEdge(this.x,this.y,b,c)};Cell.prototype.getPath=function(a,b){var c=this.maze.getPath(this.x,this.y,a,b);if(null===c)return null;c=((this.x!==c[0][0]?c[0][0]-this.x+1:c[0][1]-this.y+2)-this.dir+4)%4;2===c&&(c=1);return Cell.invDirTable[c]};
Cell.prototype.getPathToUnknown=function(){var a=this.maze.getPathToUnknown(this.x,this.y);if(null===a)return null;a=((this.x!==a[0][0]?a[0][0]-this.x+1:a[0][1]-this.y+2)-this.dir+4)%4;2===a&&(a=1);return Cell.invDirTable[a]};Cell.prototype.turn=function(a){this.dir+=Cell.dirTable[a];this.dir%=4};Cell.prototype.move=function(a){0===this.dir?this.x-=a:1===this.dir?this.y-=a:2===this.dir?this.x+=a:3===this.dir&&(this.y+=a);this.maze.setExplored(this.x,this.y)};
Cell.prototype.getData=function(){return[this.x,this.y,this.dir]};"undefined"===typeof window&&(exports.Maze=Maze,exports.Cell=Cell);